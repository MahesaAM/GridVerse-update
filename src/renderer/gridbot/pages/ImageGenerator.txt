import React, {
  useState,
  useEffect,
  useRef,
  useCallback,
  useLayoutEffect,
  memo
} from "react";
import { useNavigate } from "react-router-dom";
import { Clock, Loader2 } from "lucide-react";
import AutoSizer from "react-virtualized-auto-sizer";
import { VariableSizeList as List } from "react-window";

const ASPECT_OPTIONS = [
  { label: "Landscape 4:3", value: "IMAGE_ASPECT_RATIO_LANDSCAPE_FOUR_THREE" },
  { label: "Landscape 16:9", value: "IMAGE_ASPECT_RATIO_LANDSCAPE" },
  { label: "Portrait 3:4",  value: "IMAGE_ASPECT_RATIO_PORTRAIT_THREE_FOUR" },
  { label: "Portrait 9:16", value: "IMAGE_ASPECT_RATIO_PORTRAIT" },
  { label: "Square",        value: "IMAGE_ASPECT_RATIO_SQUARE" },
];

const ShinyText = ({ children }) => (
  <span
    className="relative overflow-hidden
               bg-gradient-to-r from-transparent via-white to-transparent
               bg-[length:200%] bg-clip-text text-transparent
               animate-shimmer"
  >
    {children}
  </span>
);

// LogRow with dynamic height measurement
const LogRow = memo(({ index, style, data }) => {
  const { logs, downloadImage, retryPrompt, setSize } = data;
  const log = logs[index];
  const contentRef = useRef(null);

  // Measure and report height
  const measure = useCallback(() => {
    if (contentRef.current) {
      const h = contentRef.current.getBoundingClientRect().height;
      setSize(index, h);
    }
  }, [index, setSize]);

  // Re-measure whenever prompt or images change
  useLayoutEffect(() => {
    measure();
  }, [measure, log.prompt, log.images]);

  return (
    <div style={style}>
      <div ref={contentRef} className="px-4 py-2">
        <div className="bg-white/7 border-l-4 border-white p-4 rounded-lg">
          {log.prompt ? (
            <>
              <div className="flex items-center gap-2">
                {log.status === "pending" ? (
                  <ShinyText>
                    Prompt({index + 1}): {log.prompt}
                  </ShinyText>
                ) : (
                  <span>
                    Prompt({index + 1}): {log.prompt}
                  </span>
                )}
                {log.status === "pending" && (
                  <Loader2 className="w-4 h-4 animate-spin" />
                )}
                {log.status === "success" && log.images && (
                  <span className="ml-2 text-green-300">
                    ‚úÖ {log.images.length} Image.
                  </span>
                )}
                {log.status === "error" && (
                  <span className="ml-2 text-red-400">
                    ‚ùå {log.message}
                  </span>
                )}
                {log.status === "error" && (
                  <button
                    onClick={() => retryPrompt(log.prompt)}
                    className="ml-auto px-3 py-1 text-sm
                               bg-purple-600 text-white rounded-md
                               hover:bg-purple-700"
                  >
                    Retry
                  </button>
                )}
              </div>
              {log.images && (
                <div className="grid grid-cols-2 gap-3 mt-3">
                  {log.images.map((img, idx) => (
                    <div key={idx} className="flex flex-col items-start gap-1">
                      <img
                        src={img.url}
                        alt={`Generated ${idx + 1}`}
                        loading="lazy"
                        className="max-w-[180px] rounded-lg
                                   shadow-[0_0_15px_rgba(128,0,255,0.3)]
                                   opacity-0 transition-opacity duration-500"
                        onLoad={e => {
                          e.currentTarget.classList.add("opacity-100");
                          measure(); // re-measure after image loads
                        }}
                      />
                      <button
                        onClick={() => downloadImage(img.url, img.filename)}
                        className="mt-1 px-3 py-1 text-sm
                                   bg-amber-500 text-gray-900
                                   rounded-md"
                      >
                        Download
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </>
          ) : (
            <strong>{log.message}</strong>
          )}
        </div>
      </div>
    </div>
  );
});

export default function ImageGenerator() {
  const navigate = useNavigate();

  // Sidebar states
  const [prompts, setPrompts]                 = useState("");
  const [originalPrompts, setOriginalPrompts] = useState([]);
  const [aspect, setAspect]                   = useState(ASPECT_OPTIONS[0].value);
  const [candidatesCount, setCandidatesCount] = useState(4);
  const [autoDownload, setAutoDownload]       = useState(true);
  const [bearerToken, setBearerToken]         = useState(() =>
    localStorage.getItem("bearerToken") || ""
  );
  const [downloadPath, setDownloadPath]       = useState("");
  const [expiresAtDisplay, setExpiresAtDisplay] = useState("");
  
  // Generation & logs
  const [logs, setLogs]                       = useState([]);
  const [isGenerating, setIsGenerating]       = useState(false);
  const [abortController, setAbortController] = useState(null);
  const cancelRef                             = useRef(false);

  // Dynamic row sizes
  const listRef = useRef(null);
  const [sizes, setSizes] = useState({});
  const setSize = useCallback((index, size) => {
    setSizes(prev => {
      if (prev[index] === size) return prev;
      const next = { ...prev, [index]: size };
      listRef.current?.resetAfterIndex(index);
      return next;
    });
  }, []);
  const getSize = index => sizes[index] ?? 100;

  // ‚Äî Auth & expiration check ‚Äî
  useEffect(() => {
    const token     = localStorage.getItem("token");
    const expiresAt = localStorage.getItem("expiresAt");
    if (!token) {
      navigate("/login");
    } else if (token === "admin-token") {
      navigate("/admin");
    } else if (expiresAt && new Date(expiresAt) < new Date()) {
      localStorage.removeItem("token");
      localStorage.removeItem("expiresAt");
      navigate("/login");
    } else if (expiresAt) {
      try {
        const d = new Date(expiresAt);
        setExpiresAtDisplay(
          d.toLocaleDateString("id-ID", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        );
      } catch {
        setExpiresAtDisplay(expiresAt);
      }
    }
  }, [navigate]);

  // ‚Äî Electron download path listener ‚Äî
  useEffect(() => {
    if (window.electronAPI?.onDownloadPathChanged) {
      window.electronAPI.onDownloadPathChanged(path => {
        setDownloadPath(path);
      });
    }
  }, []);

  // ‚Äî Download helper ‚Äî
  const downloadImage = useCallback((url, filename) => {
    let uniqueFilename = filename;
    if (!filename.includes(Date.now().toString())) {
      const dotIndex = filename.lastIndexOf(".");
      if (dotIndex === -1) {
        uniqueFilename = `${filename}_${Date.now()}`;
      } else {
        uniqueFilename = `${filename.substring(0, dotIndex)}_${Date.now()}${filename.substring(dotIndex)}`;
      }
    }
    if (window.electronAPI?.download) {
      window.electronAPI.download(url, uniqueFilename);
    } else {
      const a = document.createElement("a");
      a.href = url;
      a.download = uniqueFilename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  }, []);

  // ‚Äî Core image generation logic ‚Äî
  const generateForPrompts = useCallback(
    async lines => {
      if (!lines.length) {
        setLogs(l => [
          ...l,
          {
            id: Date.now(),
            prompt: "",
            status: "error",
            message: "‚ö†Ô∏è Prompt belum diisi.",
          },
        ]);
        return;
      }

      setIsGenerating(true);
      cancelRef.current = false;

      for (let i = 0; i < lines.length; i++) {
        if (cancelRef.current) break;

        const prompt = lines[i];
        const logId  = Date.now() + i;
        setLogs(l => [...l, { id: logId, prompt, status: "pending" }]);

        try {
          const controller = new AbortController();
          setAbortController(controller);

          const body = {
            userInput: { candidatesCount, prompts: [prompt], seed: 602603 },
            clientContext: { sessionId: `;${Date.now()}`, tool: "IMAGE_FX" },
            modelInput: { modelNameType: "IMAGEN_3_1" },
            aspectRatio: aspect,
          };

          let timeoutId;
          const timeoutP = new Promise((_, reject) => {
            timeoutId = setTimeout(() => {
              controller.abort();
              reject(new Error("Request to external API timed out (20 seconds)."));
            }, 20000);
          });

          const fetchP = fetch(
            "https://aisandbox-pa.googleapis.com/v1:runImageFx",
            {
              method: "POST",
              headers: {
                accept: "*/*",
                "content-type": "application/json",
                Authorization: `Bearer ${bearerToken}`,
              },
              body: JSON.stringify(body),
              signal: controller.signal,
            }
          );

          const res = await Promise.race([fetchP, timeoutP]);
          clearTimeout(timeoutId);
          setAbortController(null);

          const data = await res.json();
          if (res.status === 200) {
            const panel     = data.imagePanels?.[0];
            const rawImages = panel?.generatedImages || [];
            if (!rawImages.length) throw new Error("No images were generated.");

            const images = rawImages.map((img, idx) => {
              const b64  = img.encodedImage || img.base64 || img.image || "";
              const url  = `data:image/jpeg;base64,${b64}`;
              const name = prompt
                .replace(/[^a-z0-9]/gi, "_")
                .substring(0, 20);
              return {
                filename: `${name}_${Date.now()}_${idx + 1}.jpg`,
                url,
              };
            });

            setLogs(l =>
              l.map(x =>
                x.id === logId ? { ...x, status: "success", images } : x
              )
            );
            if (autoDownload) {
              images.forEach((img, idx) =>
                setTimeout(() => downloadImage(img.url, img.filename), idx * 1200)
              );
            }
          } else {
            let msg;
            switch (res.status) {
              case 401:
                msg = "Unauthorized access (401).";
                break;
              case 429:
                msg = "API limit reached (429).";
                break;
              default:
                msg = data.error || data.message || `Status ${res.status}`;
            }
            throw new Error(msg);
          }
        } catch (err) {
          const message =
            err.name === "AbortError"
              ? "Dibatalkan oleh pengguna."
              : err.message || "Unknown error";

          setLogs(l =>
            l.map(x =>
              x.id === logId ? { ...x, status: "error", message } : x
            )
          );
          setAbortController(null);

          if (
            message === "Unauthorized access (401)." ||
            message === "API limit reached (429)."
          ) {
            alert(message);
            setIsGenerating(false);
            return;
          }
        }
      }

      setIsGenerating(false);
      setAbortController(null);
      setLogs(l => [
        ...l,
        {
          id: Date.now() + 9999,
          prompt: "",
          status: "success",
          message: "‚úÖ Semua prompt selesai diproses.",
        },
      ]);
    },
    [aspect, autoDownload, bearerToken, candidatesCount, downloadImage]
  );

  // ‚Äî Handlers for control buttons ‚Äî
  const handleGenerate = async () => {
    if (isGenerating) {
      cancelRef.current = true;
      abortController?.abort();
      setIsGenerating(false);
      return;
    }
    const lines = prompts
      .split("\n")
      .map(l => l.trim())
      .filter(Boolean);
    setOriginalPrompts(lines);
    setLogs([]);
    await generateForPrompts(lines);
  };

  const retryPrompt = useCallback(
    async prompt => {
      setLogs(l => l.filter(x => !(x.prompt === prompt && x.status === "error")));
      await generateForPrompts([prompt]);
    },
    [generateForPrompts]
  );

  const handleResume = async () => {
    if (isGenerating) return;
    const toResume = originalPrompts.filter(
      p => !logs.some(x => x.prompt === p && x.status === "success")
    );
    if (!toResume.length) return;
    setLogs(l => l.filter(x => x.status === "success"));
    await generateForPrompts(toResume);
  };

  const retryAllFailed = async () => {
    const failed = logs
      .filter(x => x.status === "error")
      .map(x => x.prompt);
    if (!failed.length) return;
    setLogs(l => l.filter(x => x.status !== "error"));
    await generateForPrompts(failed);
  };

  const handleChangeDownloadPath = async () => {
    if (window.electronAPI?.openFolderDialog) {
      const path = await window.electronAPI.openFolderDialog();
      if (path) {
        setDownloadPath(path);
        window.electronAPI.setDownloadPath?.(path);
      }
    }
  };

  const handleLogout = () => {
    localStorage.removeItem("token");
    localStorage.removeItem("expiresAt");
    navigate("/login");
  };

  // ‚Äî Auto-scroll on new log entry ‚Äî
  useLayoutEffect(() => {
    if (listRef.current && logs.length > 0) {
      listRef.current.scrollToItem(logs.length - 1);
    }
  }, [logs]);

  return (
    <div className="relative flex h-screen bg-[#18191F] text-gray-300">
      <aside className="w-80 bg-[#1C1E2B] flex-shrink-0 flex flex-col overflow-y-auto hide-scrollbar">
        {/* Header */}
        <div className="flex items-center justify-between px-4 py-3">
          <button className="flex items-center bg-[#2E3042] px-4 py-1 rounded-full hover:bg-[#353846] transition">
            <Clock className="w-4 h-4 text-purple-400" />
            <span className="ml-2 text-sm text-gray-200">Expired</span>
            <span className="ml-1 text-sm text-gray-400">
              {expiresAtDisplay || "-"}
            </span>
          </button>
          <button
            onClick={handleLogout}
            title="Logout"
            className="w-8 h-8 flex items-center justify-center bg-white rounded-full transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              className="w-4 h-4 text-black"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M5 3h10v2H7v14h8v2H5V3zm14 8l-4-4v3H9v2h6v3l4-4z" />
            </svg>
          </button>
        </div>

        {/* Prompt input */}
        <div className="px-4 py-5 space-y-6 flex-1">
          <div>
            <label className="block text-sm text-gray-400 mb-1">
              Describe the image you want to generate
            </label>
            <textarea
              rows={4}
              value={prompts}
              onChange={e => setPrompts(e.target.value)}
              disabled={isGenerating}
              placeholder={"Prompt 1\nPrompt 2\nPrompt 3"}
              className="w-full bg-[#2E3042]/40 backdrop-blur-sm border border-[#3A3C4D]
                         rounded-lg p-3 text-white placeholder-gray-500
                         focus:outline-none focus:ring-2 focus:ring-[#8B5CF6]"
            />
            <div className="flex justify-between mt-1 text-xs text-gray-400 px-1">
              <span>
                Total Prompt:{" "}
                {prompts.split("\n").filter(line => line.trim()).length}
              </span>
            </div>
          </div>

          {/* Aspect ratio */}
          <div>
            <div className="text-sm text-gray-400">Aspect ratio</div>
            <div className="mt-2 flex flex-wrap gap-2">
              {ASPECT_OPTIONS.map(({ label, value }) => (
                <button
                  key={value}
                  onClick={() => setAspect(value)}
                  disabled={isGenerating}
                  className={`py-2 px-3 text-sm rounded-lg whitespace-nowrap ${
                    aspect === value
                      ? "bg-[#3A3C4D] text-white border-2 border-white"
                      : "bg-[#2E3042] text-gray-400"
                  }`}
                >
                  {label}
                </button>
              ))}
            </div>
          </div>

          {/* Images per prompt */}
          <div>
            <label className="block text-sm text-gray-400 mb-1">
              Images per prompt
            </label>
            <select
              value={candidatesCount}
              onChange={e => setCandidatesCount(+e.target.value)}
              disabled={isGenerating}
              className="w-full bg-[#2E3042]/40 border border-[#3A3C4D]
                         rounded-lg p-2 text-white focus:outline-none
                         focus:ring-2 focus:ring-[#8B5CF6]"
            >
              {[1, 2, 3, 4].map(n => (
                <option key={n} value={n}>
                  {n}
                </option>
              ))}
            </select>
          </div>

          {/* Download folder */}
          <div>
            <label className="block text-sm text-gray-300 mb-2">
              Download Folder
            </label>
            <div className="flex gap-2">
              <input
                type="text"
                readOnly
                value={downloadPath}
                className="flex-1 bg-[#2e2e2e] border border-gray-600
                           rounded px-2 py-1 text-sm text-white"
              />
              <button
                onClick={handleChangeDownloadPath}
                className="bg-purple-600 hover:bg-purple-700
                           text-sm text-white px-3 py-1 rounded"
              >
                Choose
              </button>
            </div>
          </div>

          {/* Auto-download */}
          <div className="flex items-center justify-between">
            <label htmlFor="autoDownloadSwitch" className="text-sm text-gray-300">
              Auto-download
            </label>
            <input
              id="autoDownloadSwitch"
              type="checkbox"
              checked={autoDownload}
              onChange={() => setAutoDownload(v => !v)}
              className="w-5 h-5 text-purple-500 bg-gray-700
                         border-gray-600 rounded focus:ring-purple-500"
            />
          </div>

          {/* Bearer token */}
          <div>
            <label htmlFor="bearerTokenInput" className="block text-sm text-gray-300 mb-1">
              Bearer Token
            </label>
            <input
              id="bearerTokenInput"
              type="text"
              value={bearerToken}
              onChange={e => {
                setBearerToken(e.target.value);
                localStorage.setItem("bearerToken", e.target.value);
              }}
              placeholder="Enter your bearer token"
              disabled={isGenerating}
              className="w-full bg-[#2E3042]/40 backdrop-blur-sm
                         border border-[#3A3C4D] rounded-lg p-2
                         text-white placeholder-gray-500
                         focus:outline-none focus:ring-2 focus:ring-[#8B5CF6]"
            />
          </div>

          {/* Controls */}
          <div className="mt-4 flex gap-3">
            <button
              onClick={handleGenerate}
              disabled={!prompts.trim() || !bearerToken.trim()}
              className={`flex-1 py-3 text-base font-semibold rounded-lg
                         transition-colors duration-200 ease-in-out
                         flex justify-center items-center gap-2
                         ${
                           isGenerating || !prompts.trim() || !bearerToken.trim()
                             ? "bg-gray-600 text-gray-400 cursor-not-allowed"
                             : "bg-purple-600 text-white hover:bg-purple-700"
                         }`}
            >
              {isGenerating ? (
                <>
                  {logs.length}/{originalPrompts.length}
                  <Loader2 className="w-5 h-5 animate-spin ml-2" />
                </>
              ) : (
                "Generate"
              )}
            </button>

            {!isGenerating &&
              originalPrompts.length > 0 &&
              logs.some(x => x.status !== "success") && (
                <button
                  onClick={handleResume}
                  className="px-5 py-3 bg-yellow-600 text-white
                             rounded-lg hover:bg-yellow-700 transition-colors
                             duration-200 ease-in-out font-semibold"
                >
                  Resume
                </button>
              )}

            {isGenerating && (
              <button
                onClick={() => {
                  cancelRef.current = true;
                  abortController?.abort();
                  setIsGenerating(false);
                }}
                className="px-5 py-3 bg-red-600 text-white
                           rounded-lg hover:bg-red-700 transition-colors
                           duration-200 ease-in-out font-semibold"
              >
                üõë Stop
              </button>
            )}
          </div>

          {logs.some(x => x.status === "error") && (
            <button
              onClick={retryAllFailed}
              disabled={isGenerating}
              className="w-full mt-4 py-3 text-sm bg-purple-600
                         text-white rounded-lg hover:bg-purple-700
                         disabled:opacity-50 transition-colors duration-200 ease-in-out font-semibold"
            >
              Retry All Failed
            </button>
          )}
        </div>
      </aside>

      <main className="flex-1 p-6 bg-[#121419] flex flex-col min-h-0">
        {logs.length === 0 ? (
          <div className="h-full flex items-center justify-center
                          border-2 border-dashed border-[#2E3042]
                          rounded-lg">
            <div className="flex flex-col items-center justify-center">
              <img
                src="https://sf16-web-tos-buz.capcutstatic.com/obj/capcut-web-buz-sg/ies/lvweb/mweb_online_new_frame/static/image/mweb-story-guide-bg-image.ff08b4ac.png"
                alt="Guide"
                className="max-w-full max-h-full object-contain"
              />
              <p className="text-gray-500">
                Generated results will appear here
              </p>
            </div>
          </div>
        ) : (
          <div className="flex-1 min-h-0">
            <AutoSizer>
              {({ height, width }) => (
                <List
                  ref={listRef}
                  height={height}
                  width={width}
                  itemCount={logs.length}
                  itemSize={getSize}
                  itemData={{ logs, downloadImage, retryPrompt, setSize }}
                  style={{ scrollBehavior: "smooth" }}
                >
                  {LogRow}
                </List>
              )}
            </AutoSizer>
          </div>
        )}
      </main>
    </div>
  );
}
